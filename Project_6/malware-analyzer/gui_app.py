"""
Aplicación GUI mínima con PyQt5
"""
import sys
from PyQt5 import QtWidgets, QtGui, QtCore
from src.core.analyzer import MalwareAnalyzer
from src.core.hash_calculator import HashCalculator
from src.utils.keyring_manager import KeyringManager
from src.utils.logger import get_logger

logger = get_logger(__name__)


class MainWindow(QtWidgets.QMainWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle('Malware Analyzer Pro')
        self.resize(1200, 800)

        self.analyzer = MalwareAnalyzer()

        # Widgets
        self.file_label = QtWidgets.QLabel('No file selected')
        self.btn_select = QtWidgets.QPushButton('Seleccionar archivo')
        self.btn_scan = QtWidgets.QPushButton('Analizar')
        self.progress = QtWidgets.QProgressBar()
        self.output = QtWidgets.QTextEdit()
        self.output.setReadOnly(True)

        # Layout
        central = QtWidgets.QWidget()
        layout = QtWidgets.QVBoxLayout()
        hlayout = QtWidgets.QHBoxLayout()
        hlayout.addWidget(self.btn_select)
        hlayout.addWidget(self.btn_scan)
        layout.addLayout(hlayout)
        layout.addWidget(self.file_label)
        layout.addWidget(self.progress)
        layout.addWidget(self.output)
        central.setLayout(layout)
        self.setCentralWidget(central)

        # Signals
        self.btn_select.clicked.connect(self.select_file)
        self.btn_scan.clicked.connect(self.scan_file)

    def select_file(self):
        dialog = QtWidgets.QFileDialog(self)
        dialog.setFileMode(QtWidgets.QFileDialog.ExistingFile)
        if dialog.exec_():
            files = dialog.selectedFiles()
            if files:
                self.selected_file = files[0]
                self.file_label.setText(self.selected_file)

    def scan_file(self):
        if not hasattr(self, 'selected_file') or not self.selected_file:
            QtWidgets.QMessageBox.warning(self, 'Error', 'Seleccione un archivo primero')
            return

        self.output.clear()
        self.progress.setValue(0)

        # Ejecutar análisis en segundo plano
        worker = ScanWorker(self.selected_file)
        worker.signals.progress.connect(self.progress.setValue)
        worker.signals.log.connect(self.append_log)
        worker.signals.finished.connect(self.on_scan_finished)

        QtCore.QThreadPool.globalInstance().start(worker)

    def append_log(self, text):
        self.output.append(text)

    def on_scan_finished(self, result):
        self.output.append('\n=== Resultado final ===')
        self.output.append(str(result))


class WorkerSignals(QtCore.QObject):
    progress = QtCore.pyqtSignal(int)
    log = QtCore.pyqtSignal(str)
    finished = QtCore.pyqtSignal(object)


class ScanWorker(QtCore.QRunnable):
    def __init__(self, file_path):
        super().__init__()
        self.file_path = file_path
        self.signals = WorkerSignals()

    def run(self):
        analyzer = MalwareAnalyzer()
        self.signals.log.emit('Calculando hashes...')
        hashes = HashCalculator.calculate_all_hashes(self.file_path, show_progress=False)
        self.signals.log.emit(f"SHA256: {hashes['sha256']}")

        self.signals.log.emit('Iniciando análisis con VirusTotal...')
        result = analyzer.analyze_file(self.file_path, engines=['virustotal'])

        self.signals.log.emit('Análisis finalizado')
        self.signals.finished.emit(result)


def main():
    app = QtWidgets.QApplication(sys.argv)
    window = MainWindow()
    window.show()
    sys.exit(app.exec_())


if __name__ == '__main__':
    main()
