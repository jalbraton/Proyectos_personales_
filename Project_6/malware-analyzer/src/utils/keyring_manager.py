"""
Gestor seguro de API keys usando keyring del sistema
"""
import keyring
from typing import Optional, Dict

from .config import KEYRING_SERVICE, API_KEY_NAMES
from .logger import get_logger

logger = get_logger(__name__)


class KeyringManager:
    """Gestor de API keys usando el keyring del sistema operativo"""
    
    @staticmethod
    def save_key(service: str, api_key: str) -> bool:
        """
        Guarda una API key de forma segura
        
        Args:
            service: Nombre del servicio ('virustotal', 'hybrid_analysis', etc.)
            api_key: La API key a guardar
            
        Returns:
            True si se guardó correctamente
        """
        try:
            key_name = API_KEY_NAMES.get(service)
            if not key_name:
                logger.error(f"Servicio desconocido: {service}")
                return False
            
            keyring.set_password(KEYRING_SERVICE, key_name, api_key)
            logger.info(f"API key guardada para {service}")
            return True
            
        except Exception as e:
            logger.error(f"Error guardando API key para {service}: {e}")
            return False
    
    @staticmethod
    def get_key(service: str) -> Optional[str]:
        """
        Recupera una API key
        
        Args:
            service: Nombre del servicio
            
        Returns:
            La API key o None si no existe
        """
        try:
            key_name = API_KEY_NAMES.get(service)
            if not key_name:
                logger.error(f"Servicio desconocido: {service}")
                return None
            
            api_key = keyring.get_password(KEYRING_SERVICE, key_name)
            
            if api_key:
                logger.debug(f"API key recuperada para {service}")
            else:
                logger.warning(f"No hay API key guardada para {service}")
            
            return api_key
            
        except Exception as e:
            logger.error(f"Error recuperando API key para {service}: {e}")
            return None
    
    @staticmethod
    def delete_key(service: str) -> bool:
        """
        Elimina una API key
        
        Args:
            service: Nombre del servicio
            
        Returns:
            True si se eliminó correctamente
        """
        try:
            key_name = API_KEY_NAMES.get(service)
            if not key_name:
                logger.error(f"Servicio desconocido: {service}")
                return False
            
            keyring.delete_password(KEYRING_SERVICE, key_name)
            logger.info(f"API key eliminada para {service}")
            return True
            
        except Exception as e:
            logger.error(f"Error eliminando API key para {service}: {e}")
            return False
    
    @staticmethod
    def get_all_keys() -> Dict[str, Optional[str]]:
        """
        Recupera todas las API keys
        
        Returns:
            Dict con servicio: api_key (o None si no existe)
        """
        keys = {}
        
        for service in API_KEY_NAMES.keys():
            keys[service] = KeyringManager.get_key(service)
        
        return keys
    
    @staticmethod
    def check_keys_configured() -> Dict[str, bool]:
        """
        Verifica qué API keys están configuradas
        
        Returns:
            Dict con servicio: bool (True si está configurada)
        """
        status = {}
        
        for service in API_KEY_NAMES.keys():
            api_key = KeyringManager.get_key(service)
            status[service] = api_key is not None and len(api_key) > 0
        
        return status
