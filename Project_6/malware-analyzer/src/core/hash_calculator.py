"""
Calculador de hashes para archivos
Soporta MD5, SHA1, SHA256 para archivos de cualquier tamaño
"""
import hashlib
from pathlib import Path
from typing import Dict
from tqdm import tqdm

from ..utils.logger import get_logger

logger = get_logger(__name__)


class HashCalculator:
    """Calcula hashes de archivos de forma eficiente"""
    
    BUFFER_SIZE = 65536  # 64KB chunks
    
    @staticmethod
    def calculate_all_hashes(file_path: str, show_progress: bool = True) -> Dict[str, str]:
        """
        Calcula MD5, SHA1 y SHA256 de un archivo
        
        Args:
            file_path: Ruta al archivo
            show_progress: Mostrar barra de progreso
            
        Returns:
            Dict con {'md5': ..., 'sha1': ..., 'sha256': ...}
        """
        file_path = Path(file_path)
        
        if not file_path.exists():
            raise FileNotFoundError(f"Archivo no encontrado: {file_path}")
        
        file_size = file_path.stat().st_size
        
        logger.info(f"Calculando hashes para: {file_path.name} ({file_size} bytes)")
        
        # Inicializar hasheadores
        md5 = hashlib.md5()
        sha1 = hashlib.sha1()
        sha256 = hashlib.sha256()
        
        # Calcular hashes con barra de progreso
        with open(file_path, 'rb') as f:
            if show_progress:
                pbar = tqdm(total=file_size, unit='B', unit_scale=True, desc="Calculando hashes")
            
            while True:
                data = f.read(HashCalculator.BUFFER_SIZE)
                if not data:
                    break
                
                md5.update(data)
                sha1.update(data)
                sha256.update(data)
                
                if show_progress:
                    pbar.update(len(data))
            
            if show_progress:
                pbar.close()
        
        hashes = {
            'md5': md5.hexdigest(),
            'sha1': sha1.hexdigest(),
            'sha256': sha256.hexdigest()
        }
        
        logger.info(f"Hashes calculados: MD5={hashes['md5']}, SHA256={hashes['sha256'][:16]}...")
        
        return hashes
    
    @staticmethod
    def calculate_sha256(file_path: str) -> str:
        """Calcula solo SHA256 (más rápido)"""
        file_path = Path(file_path)
        sha256 = hashlib.sha256()
        
        with open(file_path, 'rb') as f:
            for chunk in iter(lambda: f.read(HashCalculator.BUFFER_SIZE), b''):
                sha256.update(chunk)
        
        return sha256.hexdigest()
    
    @staticmethod
    def verify_hash(file_path: str, expected_hash: str, algorithm: str = 'sha256') -> bool:
        """
        Verifica que el hash de un archivo coincida con el esperado
        
        Args:
            file_path: Ruta al archivo
            expected_hash: Hash esperado (en hexadecimal)
            algorithm: Algoritmo ('md5', 'sha1', 'sha256')
            
        Returns:
            True si coincide
        """
        file_path = Path(file_path)
        
        if algorithm.lower() == 'md5':
            hasher = hashlib.md5()
        elif algorithm.lower() == 'sha1':
            hasher = hashlib.sha1()
        elif algorithm.lower() == 'sha256':
            hasher = hashlib.sha256()
        else:
            raise ValueError(f"Algoritmo no soportado: {algorithm}")
        
        with open(file_path, 'rb') as f:
            for chunk in iter(lambda: f.read(HashCalculator.BUFFER_SIZE), b''):
                hasher.update(chunk)
        
        calculated_hash = hasher.hexdigest()
        matches = calculated_hash.lower() == expected_hash.lower()
        
        if matches:
            logger.info(f"Hash verificado correctamente: {algorithm.upper()}")
        else:
            logger.warning(f"Hash NO coincide: esperado={expected_hash}, calculado={calculated_hash}")
        
        return matches
